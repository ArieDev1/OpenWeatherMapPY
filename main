"""
Weather forecast fetcher using OpenWeatherMap API
"""

import requests
import json


def get_forecast(api_key, city, country):
    """
    Get weather forecast from OpenWeatherMap API.
    
    Args:
        api_key: OpenWeatherMap API key
        city: City name (e.g., "Paris")
        country: Two-letter country code (e.g., "FR")
    
    Returns:
        JSON data from API or None if request fails
    """
    # API endpoint for 5-day forecast
    url = "https://api.openweathermap.org/data/2.5/forecast"
    
    # Request parameters
    params = {
        'q': f"{city},{country}",  # Location query
        'appid': api_key,           # API authentication
        'units': 'metric'           # Use Celsius for temperature
    }
    
    try:
        # Make HTTP request with 10-second timeout
        response = requests.get(url, params=params, timeout=10)
        response.raise_for_status()  # Raise error for bad status codes
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"API error: {e}")
        return None


def count_transitions(day_forecasts):
    """
    Count major weather transitions in a day.
    
    A major transition occurs when BOTH conditions are met:
    - Weather condition changes (e.g., Clear to Rain)
    - Temperature varies by more than 3Â°C
    
    Args:
        day_forecasts: List of forecast data points for one day
    
    Returns:
        Number of major transitions detected
    """
    transitions = 0
    
    # Compare each forecast point with the previous one
    for i in range(1, len(day_forecasts)):
        prev = day_forecasts[i - 1]
        curr = day_forecasts[i]
        
        # Extract weather conditions
        prev_weather = prev['weather'][0]['main']
        curr_weather = curr['weather'][0]['main']
        
        # Extract temperatures
        prev_temp = prev['main']['temp']
        curr_temp = curr['main']['temp']
        
        # Check if weather changed
        weather_changed = prev_weather != curr_weather
        
        # Check if temperature varied significantly
        temp_changed = abs(curr_temp - prev_temp) > 3.0
        
        # Count as transition if both conditions are met
        if weather_changed and temp_changed:
            transitions += 1
    
    return transitions


def process_data(raw_data):
    """
    Transform raw API data into the desired output format.
    
    Groups forecasts by day and calculates:
    - Total precipitation (rain and snow)
    - Maximum humidity
    - Weather transitions per day
    
    Args:
        raw_data: Raw JSON data from OpenWeatherMap API
    
    Returns:
        Dictionary with processed forecast data
    """
    # Initialize result structure
    result = {
        "forecast_location_name": raw_data['city']['name'],
        "country_code": raw_data['city']['country'],
        "total_rain_period_mm": 0.0,
        "total_snow_period_mm": 0.0,
        "max_humidity_period": 0,
        "forecast_details": []
    }
    
    # Dictionary to group forecasts by date
    by_day = {}
    
    # Process each forecast point (3-hour intervals)
    for forecast in raw_data['list']:
        # Extract date from timestamp
        date = forecast['dt_txt'].split(' ')[0]
        
        # Create new day entry if it doesn't exist
        if date not in by_day:
            by_day[date] = {
                'forecasts': [],  # List of all forecasts for this day
                'rain': 0.0,      # Cumulative rain for the day
                'snow': 0.0       # Cumulative snow for the day
            }
        
        # Add this forecast to the day's list
        by_day[date]['forecasts'].append(forecast)
        
        # Get precipitation amounts (default to 0 if not present)
        rain_3h = forecast.get('rain', {}).get('3h', 0.0)
        snow_3h = forecast.get('snow', {}).get('3h', 0.0)
        
        # Add to daily totals
        by_day[date]['rain'] += rain_3h
        by_day[date]['snow'] += snow_3h
        
        # Add to period totals
        result['total_rain_period_mm'] += rain_3h
        result['total_snow_period_mm'] += snow_3h
        
        # Update maximum humidity if this is higher
        humidity = forecast['main']['humidity']
        if humidity > result['max_humidity_period']:
            result['max_humidity_period'] = humidity
    
    # Process each day's data
    for date in sorted(by_day.keys()):
        day = by_day[date]
        
        # Count major weather transitions for this day
        transitions = count_transitions(day['forecasts'])
        
        # Add day's summary to results
        result['forecast_details'].append({
            "date_local": date,
            "rain_cumul_mm": round(day['rain'], 1),
            "snow_cumul_mm": round(day['snow'], 1),
            "major_transitions_count": transitions
        })
    
    # Round period totals to 1 decimal place
    result['total_rain_period_mm'] = round(result['total_rain_period_mm'], 1)
    result['total_snow_period_mm'] = round(result['total_snow_period_mm'], 1)
    
    return result


def save_json(data, filename):
    """
    Save data to a JSON file.
    
    Args:
        data: Dictionary to save
        filename: Output filename
    """
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)


def main():
    """
    Main program entry point.
    
    Prompts user for:
    - API key
    - City name
    - Country code
    
    Then fetches, processes, and saves weather forecast data.
    """
    # Display header
    print("=" * 50)
    print("  OpenWeatherMap Forecast Fetcher")
    print("=" * 50)
    print()
    
    # Get API key from user (not stored in code for security)
    api_key = input("OpenWeatherMap API key: ").strip()
    if not api_key:
        print("Error: API key is required")
        return
    
    # Get city name
    city = input("City: ").strip()
    if not city:
        print("Error: City is required")
        return
    
    # Get country code (must be 2 letters, e.g., US, FR, GB)
    country = input("Country code (e.g., US, FR): ").strip().upper()
    if len(country) != 2:
        print("Error: Country code must be 2 letters")
        return
    
    print(f"\nFetching forecast for {city}, {country}...\n")
    
    # Fetch data from API
    data = get_forecast(api_key, city, country)
    if not data:
        print("Failed to fetch data")
        return
    
    # Process the raw data
    result = process_data(data)
    
    # Generate output filename
    filename = f"forecast_{city.lower()}_{country.lower()}.json"
    save_json(result, filename)
    
    # Display summary
    print("=" * 50)
    print("  Summary")
    print("=" * 50)
    print(f"Location: {result['forecast_location_name']}, {result['country_code']}")
    print(f"Total rain: {result['total_rain_period_mm']} mm")
    print(f"Total snow: {result['total_snow_period_mm']} mm")
    print(f"Max humidity: {result['max_humidity_period']}%")
    print(f"Saved to: {filename}")
    print("=" * 50)


# Entry point: run main() when script is executed directly
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        # Handle Ctrl+C gracefully
        print("\n\nProgram stopped")
    except Exception as e:
        # Catch any unexpected errors
        print(f"\nError: {e}")
